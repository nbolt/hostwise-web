ordinal = (n) ->
  s=["th","st","nd","rd"]
  v=n%100
  n+(s[(v-20)%10]||s[v]||s[0])


AppCtrl = ['$scope', '$http', '$timeout', ($scope, $http, $timeout) ->

]

AuthCtrl = ['$scope', '$http', '$timeout', ($scope, $http, $timeout) ->

  $scope.signin = ->
    $http.post('/auth/signin', {
      form: $scope.form
    }).success (rsp) ->
      if rsp.success
        window.location = '/'
      else
        flash('failure', rsp.message)

  $scope.step = (n) ->
    if n < 4
      success = -> angular.element('#signup .steps').css('margin-left', -(n * 600))
    else
      success = -> $http.post('/auth/phone_confirmed', { email: $scope.form.email }).success (rsp) -> window.location = '/'
    
    $http.post('/auth/signup', {
      stage: n
      form: $scope.form
      code: $scope.confirmation_code
    }).success (rsp) ->
      if rsp.success
        success()
      else
        flash('failure', rsp.message)


  flash = (type, msg) ->
    angular.element('#signup .flash').removeClass('success failure').addClass(type).css('opacity', 1).text(msg)
    $timeout((->
      angular.element('#signup .flash').css('opacity', 0)
    ), 3000)

]

app = angular.module('porter', ['ngCookies', 'ui.select2'])
  .controller('app',  AppCtrl)
  .controller('auth', AuthCtrl)
  .config ['$httpProvider', ($httpProvider) ->
    $httpProvider.defaults.headers.common['X-CSRF-Token'] = angular.element('meta[name=csrf-token]').attr 'content'
  ]

angular.element(document).on 'ready page:load', -> angular.bootstrap('body', ['porter'])