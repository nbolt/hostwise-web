AppCtrl = ['$scope', '$http', '$timeout', ($scope, $http, $timeout) ->

  $scope.$on 'fetch_user', ->
    if window.location.href.indexOf('/activate') > 0
      $http.get(window.location.href + '.json').success (rsp) ->
        $scope.user = rsp if rsp
    else
      $http.get('/user').success (rsp) ->
        if rsp
          $scope.user = rsp
          if $scope.user.role is 'host'
            $scope.user.payments = _($scope.user.payments).filter (payment) -> payment.status_cd == 1
            $scope.user.properties = _($scope.user.properties).filter (property) -> property.active

  $scope.$emit 'fetch_user'

]

app = angular.module('porter', ['ngCookies',
                                'ui.mask',
                                'ui.select2',
                                'ui.slider',
                                'ngDialog',
                                'ngTouch',
                                'angular-carousel',
                                'angularFileUpload',
                                'angularUtils.directives.dirPagination'])
  .controller('app', AppCtrl)
  .config ['$httpProvider', ($httpProvider) ->
    $httpProvider.defaults.headers.common['X-CSRF-Token'] = angular.element('meta[name=csrf-token]').attr 'content'
  ]

angular.element(document).on 'ready page:load', -> angular.bootstrap('body', ['porter'])
