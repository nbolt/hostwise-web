JobsCtrl = ['$scope', '$http', '$timeout', '$interval', '$window', 'ngDialog', ($scope, $http, $timeout, $interval, $window, ngDialog) ->
  
  $scope.tabs = [{name:'open'},{name:'upcoming'},{name:'past'}]
  $scope.filter = {id:'recent',text:'Most Recent'}
  faye = null

  $scope.tab = (name) ->
    angular.element('#jobs .tabs .tab').removeClass 'active'
    angular.element('#jobs .tab-content .tab').removeClass 'active'
    angular.element("#jobs .tabs .tab.#{name}").addClass 'active'
    angular.element("#jobs .tab-content .tab.#{name}").addClass 'active'
    null

  $scope.filters = ->
    {
      dropdownCssClass: 'details'
      minimumResultsForSearch: -1
      data: [{id:'recent',text:'Most Recent'}]
      initSelection: (el, cb) ->
    }

  $scope.claim = (job) ->
    $http.post("/jobs/#{job.id}/claim").success (rsp) ->
      if rsp.success
        angular.element("#job-#{job.id}").fadeOut()
        $timeout((->refresh_jobs()),600)
      else
        refresh_jobs()

  $scope.drop = (job) ->
    $http.post("/jobs/#{job.id}/drop").success (rsp) ->
      if rsp.success
        angular.element("#job-#{job.id}").fadeOut()
        $timeout((->refresh_jobs()),600)
      else
        refresh_jobs()

  refresh_jobs = ->
    _($scope.tabs).each (tab) ->
      $http.get('/data/jobs', {params: {scope: tab.name, sort: $scope.filter.id}}).success (rsp) ->
        if tab.name == 'open' && !tab.days # there's a better way to do this
          angular.element('.tab-content .tab:eq(0)').addClass 'active'
        tab.days = rsp
        _(tab.days).each (day) ->
          day.push {}
          date = moment.utc(day[0],"YYYY-MM-DD")
          date_text = date.format("ddd, MMM D")
          if date.month() == moment().month()
            if date.date() == moment().date()
              date_text += ', Today'
            else if date.date() == moment().date() + 1
              date_text += ', Tomorrow'
          day[2].date_text = date_text



  $scope.$watch 'filter', (n,o) -> if o
    refresh_jobs()

  load_faye = null
  load_faye = $interval((->
    if $window.faye_loaded
      $interval.cancel(load_faye)
      faye = new Faye.Client "http://pubsub.fanout.io/r/<%= ENV['FANOUT_ID'] %>/bayeux"
      faye.subscribe '/jobs', (data) -> refresh_jobs()
  ), 200)

]

app = angular.module('porter').controller('jobs', JobsCtrl)
